const format=require("./format-parser"),URI=require("urijs"),fs=require("fs"),request=require("request-promise-native"),cacheManager=require("./cache"),xpath=require("xpath"),DOMParser=require("xmldom").DOMParser,htmlparser2=require("htmlparser2"),domParser=new DOMParser({errorHandler:{warning:e=>{},error:e=>{},fatalError:e=>{}}});let ruleMap={},config=null;function applyConfig(e){config=e}function clearCache(){cacheManager.clear()}function makeupSearchOption({id:e,keyword:t,page:r,sort:a}){const o=getRuleById(e),n=Math.max(1,r||null),c=Object.keys(o.paths),s=-1!==c.indexOf(a)?a:c[0],i=o.url+o.paths[s].replace(/{k}/g,encodeURIComponent(t)).replace(/{p}/g,n);return{id:o.id,keyword:t,page:n,sort:s,url:i}}function getRuleById(e){return ruleMap[e]||ruleMap[Object.keys(ruleMap)[0]]}async function requestDocument(e,t){const r=config.timeout||1e4,a=config.proxy?`http://${config.proxyHost}:${config.proxyPort}`:null,o=new URI(e),n=o.host(),c=o.origin(),s={Host:n,Origin:c,Referer:c},i=t["accept-language"];s["Accept-Language"]=i||"zh-CN,zh-TW;q=0.9,zh;q=0.8,en;q=0.7,und;q=0.6,ja;q=0.5";const l=t["x-forwarded-for"];l&&(s["X-Forwarded-For"]=l);const u=t["user-agent"];if(u){const e=config.requestIdentifier&&/ windows | mac | android | ios /gi.test(u)&&process.env.npm_package_version?`${u} MWBrowser/${process.env.npm_package_version}`:u;s["User-Agent"]=config.customUserAgent&&config.customUserAgentValue?config.customUserAgentValue:e}const p={url:e,headers:s,timeout:r,proxy:a};console.info(p);const g=await request(p),f=htmlparser2.DomUtils.getOuterHTML(htmlparser2.parseDOM(g));return domParser.parseFromString(f)}async function obtainDetailResult({id:e,path:t},r){const a=getRuleById(e);if(!a||!a.xpath.detail)throw new Error("此源站没有配置详情规则");const o=a.url+t;let n=cacheManager.get(o);if(!n){n=parseDetailDocument(await requestDocument(o,r),a.xpath.detail),n&&(n.url=o,cacheManager.set(o,n))}return n}async function obtainSearchResult({id:e,url:t},r){const a=getRuleById(e);let o=cacheManager.get(t);if(!o||o.length<=0){o=parseItemsDocument(await requestDocument(t,r),a.xpath),o&&o.length>0&&cacheManager.set(t,o,config.cacheExpired)}return o}function asyncCacheSearchResult({id:e,keyword:t,page:r,sort:a},o){if(!config.preload)return;obtainSearchResult({id:e,url:makeupSearchOption({id:e,keyword:t,page:r+1,sort:a}).url},o)}function parseItemsDocument(e,t){const r=[];return xpath.select(t.group,e).forEach((e,a)=>{const o=xpath.select(t.name,e),n=format.extractTextByNode(o),c=format.extractResolution(n),s=format.extractMagnet(format.extractTextByNode(xpath.select(t.magnet,e))),i=format.extractDate(format.extractTextByNode(xpath.select(t.date,e))),l=format.extractFileSize(format.extractTextByNode(xpath.select(t.size,e))),u=t.hot?format.extractNumber(format.extractTextByNode(xpath.select(t.hot,e))):null,p=t.name+"/@href",g=format.extractTextByNode(xpath.select(p,e)),f=g?new URI(g).hostname("").toString():null;n&&r.push({name:n,magnet:s,resolution:c,date:i,size:l,hot:u,detailUrl:f})}),r}function parseDetailDocument(e,t){const r=xpath.select1(t.root,e);let a;if(t.magnet&&(a=format.extractMagnet(format.extractTextByNode(xpath.select1(t.magnet,r))),!a))return null;const o=t.files?xpath.select(t.files,r):null;let n=null;return o&&(n=[],o.forEach((e,t)=>{const r=format.splitByFileSize(format.extractTextByNode(e));n.push({name:r[0],size:format.extractFileSize(r[1])})})),{magnet:a,files:n}}async function loadRuleByURL(){const e=config.ruleUrl;let t;if(e.startsWith("http")?(console.info("获取网络规则文件",e),t=await request(e,{timeout:8e3,json:!0})):(console.info("读取本地规则文件",e),t=JSON.parse(fs.readFileSync(e))),!Array.isArray(t)||t.length<=0)throw new Error("规则格式不正确");return cacheManager.set("rule_json",JSON.stringify(t)),t.forEach(e=>{ruleMap[e.id]=e}),t}async function getRule(){const e=cacheManager.get("rule_json");return e?JSON.parse(e):await loadRuleByURL()}async function getProxyNetworkInfo(e){const t=e?`http://${config.proxyHost}:${config.proxyPort}`:null,r={url:"https://gip.dog",proxy:t,timeout:5e3,headers:{"User-Agent":"curl"}},a={url:"https://www.google.com",proxy:t,timeout:5e3};let o;try{o=await request(r)}catch(e){console.error(e)}let n=!1;const c=Date.now();try{n=(await request(a)).length>0}catch(e){console.error(e.message)}return{info:o,test:n,time:Date.now()-c}}module.exports={applyConfig:applyConfig,loadRuleByURL:loadRuleByURL,getRule:getRule,obtainSearchResult:obtainSearchResult,clearCache:clearCache,makeupSearchOption:makeupSearchOption,obtainDetailResult:obtainDetailResult,asyncCacheSearchResult:asyncCacheSearchResult,getProxyNetworkInfo:getProxyNetworkInfo};